<!DOCTYPE html>
<html class="dark" lang="tr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
    <title>Xmpti AI - Efkwn Labs</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#135bec", "background-dark": "#0a0c10" },
                    fontFamily: { "display": ["Space Grotesk", "sans-serif"] }
                },
            },
        }
    </script>
    <style>
        /* Global Reset & Security */
        :root {
            --viewport-height: 100dvh;
        }
        body { 
            -webkit-touch-callout: none; 
            -webkit-user-select: none; 
            user-select: none; 
            margin: 0; 
            padding: 0; 
            height: var(--viewport-height);
            overflow: hidden; 
            background-color: #0a0c10;
            position: fixed; 
            width: 100%;
        }
        .vibrant-bg { 
            background: radial-gradient(circle at 0% 0%, rgba(19, 91, 236, 0.12) 0%, transparent 40%), 
                        radial-gradient(circle at 100% 100%, rgba(147, 51, 234, 0.08) 0%, transparent 40%), 
                        #0a0c10; 
            height: 100%; 
            display: flex;
        }
        /* UI Elements */
        .glass-panel { 
            background: rgba(10, 12, 16, 0.8); 
            backdrop-filter: blur(20px); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.08); 
            padding-top: env(safe-area-inset-top, 0px);
        }
        .chat-bubble-ai { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* iOS Safe Area ve Klavye Fix */
        .floating-dock { 
            background: rgba(15, 20, 28, 0.98); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            margin-bottom: max(env(safe-area-inset-bottom), 0.5rem); 
        }
        
        /* Code Blocks */
        pre { background: #000 !important; padding: 1.25rem; border-radius: 1rem; overflow-x: auto; border: 1px solid rgba(255,255,255,0.1); user-select: text !important; margin: 12px 0; }
        code { font-family: 'Fira Code', monospace !important; user-select: text !important; font-size: 0.85rem; color: #e2e8f0; }
        
        /* Sidebar Responsive */
        @media (max-width: 768px) {
            .sidebar-mobile { position: fixed; left: -100%; top: 0; bottom: 0; width: 85%; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; background: #0f172a; }
            .sidebar-open { left: 0; }
            .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; z-index: 90; }
            .overlay-active { display: block; }
        }

        #chat-messages {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
            height: 100%;
            flex-grow: 1;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="bg-background-dark font-display text-slate-100 antialiased" oncontextmenu="return false;">

<div id="welcome-modal" class="fixed inset-0 flex items-center justify-center p-4 bg-black/90 z-[9999]">
    <div class="max-w-lg w-full bg-slate-900 border border-white/10 rounded-[2rem] p-8 shadow-2xl">
        <h1 class="text-2xl font-bold mb-4 text-primary">Kullanım Şartları</h1>
        <div class="text-sm text-slate-400 space-y-3 mb-8">
            <p>• <b>Efkwn Labs</b> tarafından geliştirilmiştir.</p>
            <p>• API anahtarı güvenliği kullanıcı sorumluluğundadır.</p>
            <p>• Verileriniz yerel depolamada (Local Storage) saklanır.</p>
            <p>• Kaynak kodların izinsiz dağıtılması yasaktır.</p>
        </div>
        <button onclick="acceptTerms()" class="w-full py-4 bg-primary text-white font-bold rounded-2xl hover:brightness-110 active:scale-95 transition-all">Anladım, Başla</button>
    </div>
</div>

<div class="overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div class="flex h-full w-full vibrant-bg">
    <aside id="sidebar" class="sidebar-mobile md:static md:flex w-72 h-full flex flex-col border-r border-white/5 bg-black/20 overflow-hidden">
        <div class="p-6 pt-12 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="size-9 bg-primary rounded-xl flex items-center justify-center shadow-lg shadow-primary/30 text-white">
                    <span class="material-symbols-outlined">api</span>
                </div>
                <h2 class="text-xl font-bold">Xmpti AI</h2>
            </div>
            <button class="md:hidden text-slate-400" onclick="toggleSidebar()"><span class="material-symbols-outlined">close</span></button>
        </div>
        
        <div class="px-4 mb-4">
            <button onclick="createNewChat()" class="w-full py-3 bg-primary text-white font-bold rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-primary/20">
                <span class="material-symbols-outlined text-sm">add</span> Yeni Sohbet
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-3 space-y-1" id="chat-list"></div>

        <div class="p-6 border-t border-white/5">
            <p class="text-[10px] text-slate-500 font-bold text-center tracking-widest uppercase">Efkwn Labs © 2026</p>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden h-full">
        <header class="h-auto py-4 flex items-center justify-between px-4 md:px-8 glass-panel z-40 shrink-0">
            <div class="flex items-center gap-3">
                <button class="md:hidden p-2 text-slate-400" onclick="toggleSidebar()"><span class="material-symbols-outlined">menu</span></button>
                <div class="flex items-center gap-2 bg-green-500/10 px-3 py-1 rounded-full border border-green-500/20">
                    <span class="h-1.5 w-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[10px] text-green-500 font-bold uppercase tracking-wider">Llama 3.1 Aktif</span>
                </div>
            </div>
        </header>

        <div id="chat-messages" class="flex-1 overflow-y-auto px-4 md:px-10 pt-6 pb-44 space-y-6"></div>

        <div class="absolute bottom-0 left-0 right-0 z-50 p-4 md:p-8 bg-gradient-to-t from-background-dark via-background-dark/95 to-transparent">
            <div class="max-w-3xl mx-auto">
                <div class="floating-dock rounded-2xl p-2 border border-white/10 focus-within:border-primary/50 transition-all">
                    <div class="flex items-end gap-2 px-2">
                        <textarea id="user-input" 
                            class="flex-1 bg-transparent border-none focus:ring-0 text-white text-sm py-3 max-h-40 placeholder-slate-600" 
                            placeholder="Xmpti'ye bir mesaj yazın..." 
                            rows="1"
                            oninput="adjustTextarea(this)"></textarea>
                        
                        <button id="send-btn" class="size-10 bg-primary text-white flex items-center justify-center rounded-xl shadow-lg hover:scale-105 transition-all mb-1 shrink-0">
                            <span class="material-symbols-outlined font-bold">arrow_upward</span>
                        </button>
                    </div>
                </div>
                <p class="text-center text-[9px] text-slate-600 mt-2 font-medium uppercase tracking-[0.2em]">EFKWN LABS AI SYSTEM</p>
            </div>
        </div>
    </main>
</div>

<script>
    const GROQ_API_KEY = "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";
    let currentChatId = null;
    let chats = JSON.parse(localStorage.getItem('xmpti_chats')) || {};

    marked.setOptions({ highlight: (code) => hljs.highlightAuto(code).value, breaks: true });

    // iOS Visual Viewport Fix
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            const height = window.visualViewport.height;
            document.documentElement.style.setProperty('--viewport-height', `${height}px`);
            document.body.style.height = `${height}px`;
            
            // Klavye açıldığında en alta kaydır
            if (height < window.innerHeight) {
                const container = document.getElementById('chat-messages');
                container.scrollTop = container.scrollHeight;
            }
        });
    }

    function adjustTextarea(el) {
        el.style.height = '';
        el.style.height = el.scrollHeight + 'px';
        window.scrollTo(0, 0);
    }

    document.onkeydown = (e) => {
        if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || (e.ctrlKey && e.keyCode == 85)) return false;
    };

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('sidebar-open');
        document.getElementById('sidebar-overlay').classList.toggle('overlay-active');
    }

    window.onload = () => {
        if(!localStorage.getItem('termsAccepted')) {
            document.getElementById('welcome-modal').style.display = 'flex';
        } else {
            document.getElementById('welcome-modal').style.display = 'none';
        }
        renderChatList();
        const keys = Object.keys(chats);
        if (keys.length > 0) loadChat(keys[keys.length - 1]); else createNewChat();
    };

    function acceptTerms() {
        localStorage.setItem('termsAccepted', 'true');
        document.getElementById('welcome-modal').style.display = 'none';
    }

    function createNewChat() {
        currentChatId = 'chat_' + Date.now();
        chats[currentChatId] = { title: "Yeni Sohbet", messages: [] };
        saveAndRender();
        loadChat(currentChatId);
    }

    function saveAndRender() {
        localStorage.setItem('xmpti_chats', JSON.stringify(chats));
        renderChatList();
    }

    function renderChatList() {
        const list = document.getElementById('chat-list');
        list.innerHTML = '';
        Object.keys(chats).sort((a,b) => b.split('_')[1] - a.split('_')[1]).forEach(id => {
            const isActive = id === currentChatId;
            const item = document.createElement('div');
            item.className = `flex items-center justify-between px-4 py-3 rounded-xl cursor-pointer transition-all ${isActive ? 'bg-primary/20 text-white border border-primary/30' : 'text-slate-400 hover:bg-white/5'}`;
            item.onclick = () => { loadChat(id); if(window.innerWidth < 768) toggleSidebar(); };
            item.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden">
                    <span class="material-symbols-outlined text-lg">chat_bubble</span>
                    <span class="text-sm truncate font-medium">${chats[id].title}</span>
                </div>
                <button onclick="deleteChat(event, '${id}')" class="hover:text-red-500 opacity-50 hover:opacity-100 transition-opacity"><span class="material-symbols-outlined text-sm">delete</span></button>
            `;
            list.appendChild(item);
        });
    }

    function deleteChat(e, id) {
        e.stopPropagation();
        if(confirm('Sohbeti siliyoruz, emin misin?')) {
            delete chats[id];
            const keys = Object.keys(chats);
            if (keys.length > 0) loadChat(keys[keys.length - 1]); else createNewChat();
            saveAndRender();
        }
    }

    function loadChat(id) {
        currentChatId = id;
        const container = document.getElementById('chat-messages');
        container.innerHTML = '';
        chats[id].messages.forEach(msg => displayMessage(msg.role, msg.content));
        renderChatList();
    }

    function displayMessage(role, text) {
        const container = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = `flex gap-4 max-w-full ${role === 'user' ? 'flex-row-reverse' : ''}`;
        const isUser = role === 'user';
        
        div.innerHTML = `
            <div class="size-9 rounded-xl flex items-center justify-center shrink-0 ${isUser ? 'bg-primary shadow-lg shadow-primary/20' : 'bg-slate-800'} text-white">
                <span class="material-symbols-outlined text-sm">${isUser ? 'person' : 'auto_awesome'}</span>
            </div>
            <div class="flex flex-col gap-1 max-w-[85%] ${isUser ? 'items-end' : 'items-start'}">
                <div class="${isUser ? 'bg-primary text-white shadow-md' : 'chat-bubble-ai text-slate-200'} text-[13px] px-5 py-3.5 rounded-2xl ${isUser ? 'rounded-tr-none' : 'rounded-tl-none'} prose prose-invert overflow-x-auto">
                    ${marked.parse(text)}
                </div>
            </div>
        `;
        container.appendChild(div);
        container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        document.querySelectorAll('pre code').forEach(hljs.highlightElement);
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;

        if (chats[currentChatId].messages.length === 0) chats[currentChatId].title = text.substring(0, 25);

        input.value = '';
        input.style.height = 'auto';
        displayMessage('user', text);
        chats[currentChatId].messages.push({ role: 'user', content: text });
        saveAndRender();

        try {
            const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "llama-3.1-8b-instant",
                    messages: [
                        { role: "system", content: "Sen Efkwn Labs'in asistanı Xmpti AI'sın. Türkçe ve yardımsever ol." },
                        ...chats[currentChatId].messages
                    ]
                })
            });
            if (!res.ok) throw new Error();
            const data = await res.json();
            const aiText = data.choices[0].message.content;
            displayMessage('assistant', aiText);
            chats[currentChatId].messages.push({ role: 'assistant', content: aiText });
            saveAndRender();
        } catch (e) {
            displayMessage('assistant', "Bağlantı sorunu oluştu.");
        }
    }

    document.getElementById('send-btn').onclick = sendMessage;
    document.getElementById('user-input').onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
</script>
</body>
</html>
