<!DOCTYPE html>
<html class="dark" lang="tr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Ticarisk Elite - Pro Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { 
                        primary: "#3b82f6", 
                        gold: "#fbbf24", 
                        premium: "#a855f7",
                        bgDark: "#05050a", 
                        cardDark: "#0f172a",
                        success: "#10b981",
                        danger: "#ef4444"
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'pulse-glow': 'pulse-glow 2s ease-in-out infinite',
                        'bounce-subtle': 'bounce-subtle 0.5s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'shake': 'shake 0.5s ease-in-out'
                    },
                    keyframes: {
                        'pulse-glow': {
                            '0%, 100%': { boxShadow: '0 0 20px rgba(59, 130, 246, 0.5)' },
                            '50%': { boxShadow: '0 0 40px rgba(59, 130, 246, 0.8)' }
                        },
                        'bounce-subtle': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' }
                        },
                        'float': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        'shake': {
                            '0%, 100%': { transform: 'translateX(0)' },
                            '25%': { transform: 'translateX(-5px)' },
                            '75%': { transform: 'translateX(5px)' }
                        }
                    }
                },
            },
        };
    </script>
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #05050a; color: #f8fafc; overflow-x: hidden; user-select: none; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-light { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        .ios-blur { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .pulse-emerald { animation: pulse-emerald 2s infinite; }
        @keyframes pulse-emerald { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.5); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(59, 130, 246, 0.8); }
        .wheel-section { transform-origin: center; }
        .toast { position: fixed; top: 100px; right: 20px; z-index: 9999; }
    </style>
</head>
<body class="min-h-screen transition-colors duration-300">

    <!-- Ses Efektleri -->
    <audio id="sound-click" src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" preload="auto"></audio>
    <audio id="sound-coin" src="https://assets.mixkit.co/sfx/preview/mixkit-coin-win-notification-1998.mp3" preload="auto"></audio>
    <audio id="sound-levelup" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" preload="auto"></audio>
    <audio id="sound-spin" src="https://assets.mixkit.co/sfx/preview/mixkit-casino-roulette-spin-1031.mp3" preload="auto"></audio>

    <!-- Auth Ekranƒ± -->
    <div id="auth-screen" class="fixed inset-0 z-[300] bg-bgDark flex items-center justify-center p-6">
        <div class="glass w-full max-w-md p-10 rounded-[40px] shadow-2xl text-center">
            <div class="text-6xl mb-6 animate-float">üèôÔ∏è</div>
            <h1 class="text-4xl font-black mb-2 tracking-tighter bg-gradient-to-r from-primary to-purple-600 bg-clip-text text-transparent">TICARISK ELITE</h1>
            <p class="text-slate-400 text-sm mb-8">Ticaret ƒ∞mparatorluƒüunu Y√∂net</p>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="E-posta" class="w-full p-4 rounded-2xl bg-black/40 border border-white/10 outline-none focus:border-primary transition text-white">
                <input type="password" id="password" placeholder="≈ûifre" class="w-full p-4 rounded-2xl bg-black/40 border border-white/10 outline-none focus:border-primary transition text-white">
                <div class="grid grid-cols-2 gap-4 pt-4">
                    <button onclick="handleAuth('login')" class="bg-primary hover:scale-105 py-4 rounded-2xl font-black transition-all active:scale-95" id="btn-login">Gƒ∞Rƒ∞≈û</button>
                    <button onclick="handleAuth('register')" class="bg-white/5 hover:bg-white/10 py-4 rounded-2xl font-black transition-all border border-white/10 active:scale-95" id="btn-register">KAYIT</button>
                </div>
                <div class="pt-6">
                    <button onclick="toggleTheme()" class="text-xs text-slate-500 hover:text-slate-300 flex items-center justify-center gap-2 mx-auto">
                        <i class="fas fa-moon"></i> Tema Deƒüi≈ütir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Bildirimleri -->
    <div id="toast-container" class="toast space-y-2"></div>

    <!-- Ana Oyun Ekranƒ± -->
    <div id="game-screen" class="hidden">
        <!-- Header -->
        <header class="px-6 py-4 flex items-center justify-between sticky top-0 z-[100] bg-bgDark/80 ios-blur border-b border-white/5">
            <div class="flex items-center gap-3">
                <div onclick="toggleProfile()" class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center shadow-lg shadow-primary/30 cursor-pointer">
                    <span class="material-icons-round text-white">person</span>
                </div>
                <div>
                    <h1 id="p-username" class="font-black tracking-tight text-sm">-</h1>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] bg-primary/20 text-primary px-2 py-0.5 rounded-full" id="p-rank">#0</span>
                        <span class="text-[10px] text-slate-400" id="p-premium"></span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-emerald-400 font-black text-sm px-4 py-2 bg-emerald-500/10 rounded-full border border-emerald-500/20 flex items-center gap-2" id="p-money">
                    <i class="fas fa-coins"></i> 0 ‚Ç∫
                </div>
                <div class="relative">
                    <button onclick="toggleNotifications()" class="material-icons-round text-2xl relative">
                        notifications
                        <span id="notification-badge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-[10px] rounded-full flex items-center justify-center hidden">0</span>
                    </button>
                </div>
                <button onclick="logout()" class="material-icons-round text-red-500 text-2xl">logout</button>
            </div>
        </header>

        <!-- Ana ƒ∞√ßerik -->
        <main class="px-4 pt-4 pb-32 space-y-6 max-w-2xl mx-auto">
            
            <!-- Seviye & XP -->
            <div class="glass p-6 rounded-[32px] relative overflow-hidden">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">D√ºzey & Deneyim</p>
                        <h2 class="text-3xl font-black flex items-center gap-2" id="p-level">LV 1 <span id="level-badge" class="text-xs bg-gold/20 text-gold px-2 py-0.5 rounded-full hidden">+%10 Gelir</span></h2>
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-black text-primary" id="p-xp">0/1000 XP</span>
                    </div>
                </div>
                <div class="w-full bg-black/40 h-3 rounded-full overflow-hidden mb-2">
                    <div id="xp-bar" class="bg-gradient-to-r from-primary to-blue-400 h-full w-0 transition-all duration-1000"></div>
                </div>
                <div class="flex justify-between text-[10px] text-slate-500">
                    <span>Seviye Bonusu: <span id="level-bonus">%0</span></span>
                    <span id="next-level-reward">Sonraki: 5000‚Ç∫</span>
                </div>
            </div>

            <!-- Hƒ±zlƒ± ƒ∞≈ülemler -->
            <div class="grid grid-cols-4 gap-3">
                <button onclick="openCrypto()" class="glass p-4 rounded-3xl text-center active:scale-95 transition">
                    <div class="text-2xl text-blue-400 mb-1"><i class="fab fa-bitcoin"></i></div>
                    <p class="text-[10px] font-black uppercase">Kripto</p>
                </button>
                <button onclick="openWheel()" class="glass p-4 rounded-3xl text-center active:scale-95 transition">
                    <div class="text-2xl text-gold mb-1 animate-spin-slow"><i class="fas fa-dharmachakra"></i></div>
                    <p class="text-[10px] font-black uppercase">√áark</p>
                </button>
                <button onclick="openTasks()" class="glass p-4 rounded-3xl text-center active:scale-95 transition">
                    <div class="text-2xl text-emerald-400 mb-1"><i class="fas fa-tasks"></i></div>
                    <p class="text-[10px] font-black uppercase">G√∂revler</p>
                </button>
                <button onclick="openMarket()" class="glass p-4 rounded-3xl text-center active:scale-95 transition">
                    <div class="text-2xl text-purple-400 mb-1"><i class="fas fa-store"></i></div>
                    <p class="text-[10px] font-black uppercase">Market</p>
                </button>
            </div>

            <!-- ƒ∞statistikler -->
            <div class="grid grid-cols-3 gap-3">
                <div class="glass p-4 rounded-3xl">
                    <p class="text-[10px] text-slate-400 mb-1">Toplam Kazan√ß</p>
                    <p class="font-black text-sm" id="stat-total">0 ‚Ç∫</p>
                </div>
                <div class="glass p-4 rounded-3xl">
                    <p class="text-[10px] text-slate-400 mb-1">Aktif ƒ∞≈üler</p>
                    <p class="font-black text-sm" id="stat-active">0</p>
                </div>
                <div class="glass p-4 rounded-3xl">
                    <p class="text-[10px] text-slate-400 mb-1">M√ºlk Sayƒ±sƒ±</p>
                    <p class="font-black text-sm" id="stat-properties">0</p>
                </div>
            </div>

            <!-- Crypto Fiyat G√∂stergesi -->
            <div class="glass p-4 rounded-3xl">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center">
                            <i class="fab fa-bitcoin text-blue-400"></i>
                        </div>
                        <div>
                            <p class="font-black text-sm">TCR Coin</p>
                            <p class="text-[10px] text-slate-400">Ticarisk Kripto</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p id="crypto-price" class="text-xl font-black text-blue-400">‚Ç∫15.4</p>
                        <p id="crypto-change" class="text-[10px] text-emerald-400">+2.4%</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="buyCrypto(1000)" class="flex-1 bg-emerald-500/20 text-emerald-400 py-2 rounded-xl text-xs font-black active:scale-95">AL</button>
                    <button onclick="sellCrypto(1000)" class="flex-1 bg-red-500/20 text-red-400 py-2 rounded-xl text-xs font-black active:scale-95">SAT</button>
                </div>
            </div>

            <!-- G√ºnl√ºk √áark -->
            <div id="wheel-section" class="glass p-6 rounded-[32px] text-center">
                <h3 class="text-lg font-black mb-4 flex items-center justify-center gap-2"><i class="fas fa-gift text-gold"></i> G√úNL√úK √áARK</h3>
                <div class="relative w-48 h-48 mx-auto mb-6">
                    <div id="wheel" class="w-full h-full rounded-full relative overflow-hidden">
                        <!-- √áark dilimleri -->
                    </div>
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-bgDark rounded-full flex items-center justify-center">
                        <i class="fas fa-gift text-2xl text-gold"></i>
                    </div>
                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-3xl">‚Üì</div>
                </div>
                <button onclick="spinDailyWheel()" id="spin-btn" class="w-full py-4 bg-gradient-to-r from-gold to-orange-500 rounded-2xl font-black text-lg active:scale-95 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="spin-text">√áARKI √áEVƒ∞R (G√úNL√úK)</span>
                    <div id="wheel-timer" class="text-xs font-normal mt-1 hidden">Sonraki: <span id="timer">24:00:00</span></div>
                </button>
            </div>

            <!-- G√∂revler -->
            <section>
                <h3 class="text-lg font-black mb-4 flex items-center gap-2"><span class="w-1 h-5 bg-primary rounded-full"></span> G√úNL√úK G√ñREVLER</h3>
                <div id="tasks-container" class="space-y-3"></div>
            </section>

            <!-- ƒ∞≈ü Merkezi -->
            <section>
                <h3 class="text-lg font-black mb-4 flex items-center gap-2"><span class="w-1 h-5 bg-emerald-500 rounded-full"></span> ƒ∞≈û MERKEZƒ∞</h3>
                <div id="work-progress-box" class="hidden mb-4 glass p-4 rounded-2xl text-center border-blue-500/50">
                    <p class="text-xs font-black text-blue-400 mb-2 uppercase">√áalƒ±≈üƒ±lƒ±yor...</p>
                    <div class="w-full bg-black/40 h-2 rounded-full overflow-hidden"><div id="work-bar" class="bg-blue-500 h-full w-0"></div></div>
                    <p class="text-xs text-slate-400 mt-2" id="work-time-left">Kalan: 60s</p>
                </div>
                <div id="job-grid" class="space-y-3"></div>
            </section>

            <!-- M√ºlkler -->
            <section>
                <h3 class="text-lg font-black mb-4 flex items-center gap-2"><span class="w-1 h-5 bg-purple-500 rounded-full"></span> M√úLKLERƒ∞M</h3>
                <div id="biz-grid" class="space-y-4"></div>
            </section>

            <!-- Klanlar -->
            <section class="glass p-6 rounded-[32px]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest">KLANLAR</h3>
                    <button onclick="openClans()" class="text-xs text-primary font-black">T√úM√ú</button>
                </div>
                <div id="clan-list" class="space-y-3">
                    <!-- Klanlar buraya gelecek -->
                </div>
            </section>

            <!-- Liderlik Tablosu -->
            <section class="glass p-6 rounded-[32px]">
                <h3 class="text-xs font-black text-slate-500 mb-4 uppercase tracking-widest">Global Zenginler</h3>
                <div id="leaderboard" class="space-y-4"></div>
            </section>
        </main>

        <!-- Bottom Nav -->
        <nav class="fixed bottom-0 left-0 right-0 p-4 z-[150]">
            <div class="max-w-md mx-auto glass rounded-[30px] p-2 flex justify-between items-center shadow-2xl">
                <button onclick="openDashboard()" class="flex-1 py-3 text-primary text-center"><i class="fas fa-home text-lg"></i></button>
                <button onclick="openBusiness()" class="flex-1 py-3 text-slate-500 text-center"><i class="fas fa-briefcase text-lg"></i></button>
                <button onclick="openWheel()" class="flex-1 py-3 text-slate-500 text-center relative">
                    <i class="fas fa-gift text-lg"></i>
                </button>
                <button onclick="toggleChat()" class="flex-1 py-3 text-slate-500 text-center"><i class="fas fa-comments text-lg"></i></button>
                <button onclick="openMarket()" class="flex-1 py-3 text-slate-500 text-center"><i class="fas fa-store text-lg"></i></button>
            </div>
        </nav>

        <!-- Chat Button -->
        <button onclick="toggleChat()" class="fixed bottom-28 right-6 w-14 h-14 bg-primary rounded-2xl shadow-2xl shadow-primary/40 flex items-center justify-center z-50 animate-pulse-glow">
            <i class="fas fa-comment-dots text-white text-xl"></i>
        </button>
    </div>

    <!-- Modallar -->
    <div id="chat-modal" class="fixed inset-0 z-[200] bg-bgDark hidden flex flex-col">
        <div class="p-6 border-b border-white/5 flex justify-between items-center">
            <h2 class="font-black">GLOBAL CHAT <span class="text-xs text-primary" id="online-count">(0)</span></h2>
            <button onclick="toggleChat()" class="material-icons-round">close</button>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
        <div class="p-6 glass border-t border-white/10 flex gap-2">
            <input type="text" id="chat-input" placeholder="Mesaj..." class="flex-1 bg-black/40 p-4 rounded-2xl outline-none" onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="bg-primary px-6 rounded-2xl material-icons-round">send</button>
        </div>
    </div>

    <!-- Profil Modal -->
    <div id="profile-modal" class="fixed inset-0 z-[400] bg-black/95 hidden flex items-center justify-center p-6 ios-blur">
        <div class="glass w-full max-w-sm rounded-[40px] overflow-hidden">
            <div class="h-24 bg-gradient-to-r from-primary to-blue-800 flex justify-end p-4">
                <button onclick="closeProfile()" class="material-icons-round text-white">close</button>
            </div>
            <div class="px-8 pb-8 text-center -mt-12">
                <div class="w-24 h-24 bg-cardDark rounded-3xl border-4 border-cardDark mx-auto flex items-center justify-center text-4xl font-black shadow-2xl mb-2" id="prof-avatar">?</div>
                <button onclick="changeAvatar()" class="text-xs text-slate-400 mb-4">Avatar Deƒüi≈ütir</button>
                <h2 class="text-2xl font-black" id="prof-username">-</h2>
                <div class="flex items-center justify-center gap-2 mt-2">
                    <span class="text-xs bg-primary/20 text-primary px-2 py-0.5 rounded-full" id="prof-rank">#0</span>
                    <span class="text-xs text-gold" id="prof-premium"></span>
                </div>
                
                <div class="grid grid-cols-2 gap-3 my-6">
                    <div class="bg-white/5 p-4 rounded-3xl text-left">
                        <p class="text-[10px] text-slate-500 font-bold">BAKƒ∞YE</p>
                        <p class="text-emerald-400 font-black text-sm" id="prof-money">0 ‚Ç∫</p>
                    </div>
                    <div class="bg-white/5 p-4 rounded-3xl text-left">
                        <p class="text-[10px] text-slate-500 font-bold">SEVƒ∞YE</p>
                        <p class="text-blue-400 font-black text-sm" id="prof-level">LV 0</p>
                    </div>
                </div>
                
                <div class="bg-white/5 p-4 rounded-3xl text-left mb-4">
                    <p class="text-[10px] text-slate-400 font-bold mb-3 uppercase">ƒ∞statistikler</p>
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-xs">Toplam Kazan√ß:</span><span class="text-xs font-black" id="prof-total">0 ‚Ç∫</span></div>
                        <div class="flex justify-between"><span class="text-xs">Tamamlanan G√∂rev:</span><span class="text-xs font-black" id="prof-tasks">0</span></div>
                        <div class="flex justify-between"><span class="text-xs">√áark √áevirme:</span><span class="text-xs font-black" id="prof-spins">0</span></div>
                        <div class="flex justify-between"><span class="text-xs">Oyun S√ºresi:</span><span class="text-xs font-black" id="prof-playtime">0s</span></div>
                    </div>
                </div>
                
                <div class="bg-white/5 p-4 rounded-3xl text-left mb-6">
                    <p class="text-[10px] text-slate-400 font-bold mb-3 uppercase">Sahip Olunanlar</p>
                    <div id="prof-assets" class="flex flex-wrap gap-2"></div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="sendMoney()" class="flex-1 bg-primary py-3 rounded-2xl font-black text-xs active:scale-95">PARA G√ñNDER</button>
                    <button onclick="buyPremium()" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 py-3 rounded-2xl font-black text-xs active:scale-95">PREMIUM</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ≈ûans √áarkƒ± Modalƒ± -->
    <div id="wheel-modal" class="fixed inset-0 z-[500] bg-black/95 hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-md rounded-[40px] overflow-hidden p-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black">G√úNL√úK ≈ûANS √áARKI</h2>
                <button onclick="closeWheel()" class="material-icons-round">close</button>
            </div>
            
            <div class="relative w-64 h-64 mx-auto mb-8">
                <canvas id="wheel-canvas" width="300" height="300"></canvas>
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                    <div class="w-20 h-20 bg-bgDark rounded-full flex items-center justify-center border-4 border-gold">
                        <i class="fas fa-gift text-2xl text-gold"></i>
                    </div>
                </div>
                <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl text-gold">
                    <i class="fas fa-caret-down"></i>
                </div>
            </div>
            
            <div class="text-center mb-6">
                <p class="text-sm text-slate-400 mb-2">Kazanabileceklerin:</p>
                <div class="flex flex-wrap justify-center gap-2">
                    <span class="bg-gold/10 text-gold px-3 py-1 rounded-full text-xs">1000‚Ç∫</span>
                    <span class="bg-primary/10 text-primary px-3 py-1 rounded-full text-xs">5000‚Ç∫</span>
                    <span class="bg-emerald-500/10 text-emerald-400 px-3 py-1 rounded-full text-xs">10000‚Ç∫</span>
                    <span class="bg-purple-500/10 text-purple-400 px-3 py-1 rounded-full text-xs">+1 M√ºlk</span>
                    <span class="bg-red-500/10 text-red-400 px-3 py-1 rounded-full text-xs">x2 Gelir</span>
                </div>
            </div>
            
            <button onclick="startSpin()" id="wheel-spin-btn" class="w-full py-4 bg-gradient-to-r from-gold to-orange-500 rounded-2xl font-black text-xl active:scale-95 transition disabled:opacity-50">
                √áARKI √áEVƒ∞R
                <div id="wheel-modal-timer" class="text-sm font-normal mt-1 hidden">Sonraki: <span id="modal-timer">24:00:00</span></div>
            </button>
        </div>
    </div>

    <!-- Kripto Modalƒ± -->
    <div id="crypto-modal" class="fixed inset-0 z-[500] bg-black/95 hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-md rounded-[40px] overflow-hidden p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black flex items-center gap-2"><i class="fab fa-bitcoin text-blue-400"></i> TCR COIN BORSASI</h2>
                <button onclick="closeCrypto()" class="material-icons-round">close</button>
            </div>
            
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <p class="text-3xl font-black text-blue-400" id="crypto-modal-price">‚Ç∫15.4</p>
                        <p class="text-sm text-slate-400" id="crypto-modal-change">+2.4% (24s)</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Sahip Olunan</p>
                        <p class="text-xl font-black text-emerald-400" id="crypto-owned">0 TCR</p>
                        <p class="text-xs text-slate-400" id="crypto-value">‚âà 0 ‚Ç∫</p>
                    </div>
                </div>
                
                <div class="glass p-4 rounded-2xl mb-4">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm">Alƒ±m Miktarƒ± (‚Ç∫)</span>
                        <span class="text-sm font-black" id="buy-amount">1000</span>
                    </div>
                    <input type="range" min="100" max="100000" value="1000" class="w-full" id="buy-slider" oninput="updateBuyAmount()">
                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                        <span>100‚Ç∫</span>
                        <span>50.000‚Ç∫</span>
                        <span>100.000‚Ç∫</span>
                    </div>
                </div>
                
                <div class="glass p-4 rounded-2xl mb-6">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm">Satƒ±m Miktarƒ± (TCR)</span>
                        <span class="text-sm font-black" id="sell-amount">10</span>
                    </div>
                    <input type="range" min="1" max="10000" value="10" class="w-full" id="sell-slider" oninput="updateSellAmount()">
                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                        <span>1 TCR</span>
                        <span>5.000 TCR</span>
                        <span>10.000 TCR</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="buyCryptoModal()" class="bg-emerald-500/20 text-emerald-400 py-4 rounded-2xl font-black active:scale-95">
                        <i class="fas fa-arrow-up"></i> AL
                    </button>
                    <button onclick="sellCryptoModal()" class="bg-red-500/20 text-red-400 py-4 rounded-2xl font-black active:scale-95">
                        <i class="fas fa-arrow-down"></i> SAT
                    </button>
                </div>
            </div>
            
            <div class="text-xs text-slate-500">
                <p><i class="fas fa-info-circle"></i> Kripto fiyatlarƒ± her 5 saniyede g√ºncellenir. Yatƒ±rƒ±m risklidir.</p>
            </div>
        </div>
    </div>

    <!-- G√∂revler Modalƒ± -->
    <div id="tasks-modal" class="fixed inset-0 z-[500] bg-black/95 hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-md rounded-[40px] overflow-hidden p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black flex items-center gap-2"><i class="fas fa-tasks text-emerald-400"></i> G√ñREVLER & HEDEFLER</h2>
                <button onclick="closeTasks()" class="material-icons-round">close</button>
            </div>
            
            <div class="space-y-4 mb-6">
                <div class="glass p-4 rounded-2xl">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-black">G√ºnl√ºk G√∂revler</h3>
                        <span class="text-xs text-primary" id="daily-progress">0/3</span>
                    </div>
                    <div id="daily-tasks-list"></div>
                </div>
                
                <div class="glass p-4 rounded-2xl">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-black">Seviye √ñd√ºlleri</h3>
                        <span class="text-xs text-gold">√ñd√ºlleri Topla</span>
                    </div>
                    <div id="level-rewards-list"></div>
                </div>
            </div>
            
            <button onclick="claimAllTasks()" class="w-full py-4 bg-gradient-to-r from-emerald-500 to-green-500 rounded-2xl font-black active:scale-95">
                T√úM √ñD√úLLERƒ∞ TOPLA
            </button>
        </div>
    </div>

    <!-- Market Modalƒ± -->
    <div id="market-modal" class="fixed inset-0 z-[500] bg-black/95 hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-md rounded-[40px] overflow-hidden p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black flex items-center gap-2"><i class="fas fa-store text-purple-400"></i> ƒ∞Yƒ∞LE≈ûTƒ∞RME MARKETƒ∞</h2>
                <button onclick="closeMarket()" class="material-icons-round">close</button>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass p-4 rounded-2xl text-center">
                    <div class="text-3xl mb-2 text-gold"><i class="fas fa-coins"></i></div>
                    <h3 class="font-black text-sm mb-1">Gelir Artƒ±rƒ±cƒ±</h3>
                    <p class="text-xs text-slate-400 mb-3">+%10 daha fazla kazan</p>
                    <button onclick="buyUpgrade('income')" class="w-full bg-gold/20 text-gold py-2 rounded-xl text-xs font-black">50.000‚Ç∫</button>
                </div>
                <div class="glass p-4 rounded-2xl text-center">
                    <div class="text-3xl mb-2 text-blue-400"><i class="fas fa-bolt"></i></div>
                    <h3 class="font-black text-sm mb-1">Hƒ±z Artƒ±rƒ±cƒ±</h3>
                    <p class="text-xs text-slate-400 mb-3">ƒ∞≈ü s√ºresini kƒ±salt</p>
                    <button onclick="buyUpgrade('speed')" class="w-full bg-blue-500/20 text-blue-400 py-2 rounded-xl text-xs font-black">75.000‚Ç∫</button>
                </div>
                <div class="glass p-4 rounded-2xl text-center">
                    <div class="text-3xl mb-2 text-emerald-400"><i class="fas fa-shield-alt"></i></div>
                    <h3 class="font-black text-sm mb-1">Premium √úyelik</h3>
                    <p class="text-xs text-slate-400 mb-3">30 g√ºnl√ºk avantajlar</p>
                    <button onclick="buyUpgrade('premium')" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 py-2 rounded-xl text-xs font-black">199.000‚Ç∫</button>
                </div>
                <div class="glass p-4 rounded-2xl text-center">
                    <div class="text-3xl mb-2 text-red-400"><i class="fas fa-ticket-alt"></i></div>
                    <h3 class="font-black text-sm mb-1">Piyango Bileti</h3>
                    <p class="text-xs text-slate-400 mb-3">10.000.000‚Ç∫ ≈üansƒ±</p>
                    <button onclick="buyUpgrade('lottery')" class="w-full bg-red-500/20 text-red-400 py-2 rounded-xl text-xs font-black">5.000‚Ç∫</button>
                </div>
            </div>
            
            <div class="text-xs text-slate-500">
                <p><i class="fas fa-info-circle"></i> Y√ºkseltmeler kalƒ±cƒ±dƒ±r. Premium √ºyelik 30 g√ºn ge√ßerlidir.</p>
            </div>
        </div>
    </div>

    <!-- Klanlar Modalƒ± -->
    <div id="clan-modal" class="fixed inset-0 z-[500] bg-black/95 hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-md rounded-[40px] overflow-hidden p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black flex items-center gap-2"><i class="fas fa-users text-primary"></i> KLAN Sƒ∞STEMƒ∞</h2>
                <button onclick="closeClans()" class="material-icons-round">close</button>
            </div>
            
            <div class="space-y-4 mb-6">
                <div class="glass p-4 rounded-2xl">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h3 class="font-black">Aktif Klanƒ±n</h3>
                            <p class="text-xs text-slate-400" id="current-clan">Klanƒ±n yok</p>
                        </div>
                        <button onclick="createClan()" class="bg-primary text-white px-4 py-2 rounded-xl text-xs font-black">KLAN KUR</button>
                    </div>
                </div>
                
                <div class="glass p-4 rounded-2xl">
                    <h3 class="font-black mb-3">En ƒ∞yi Klanlar</h3>
                    <div id="top-clans-list" class="space-y-3">
                        <!-- Klanlar listesi -->
                    </div>
                </div>
            </div>
            
            <button onclick="joinClan()" class="w-full py-4 bg-primary rounded-2xl font-black active:scale-95">
                KLANA KATIL
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, update, push, serverTimestamp, onDisconnect, query, orderByChild, limitToLast, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqiGFukHcCJurBS8t35i2Q3s9nQvPdmcM",
            authDomain: "xmps-bba4a.firebaseapp.com",
            databaseURL: "https://xmps-bba4a-default-rtdb.firebaseio.com",
            projectId: "xmps-bba4a",
            storageBucket: "xmps-bba4a.firebasestorage.app",
            messagingSenderId: "348983388349",
            appId: "1:348983388349:web:e2e5c3ed06c08ef3382fd4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Oyun Deƒüi≈ükenleri
        let currentUser = null;
        let userData = {};
        let workInterval = null;
        let viewedUid = null;
        let cryptoPrice = 15.4;
        let cryptoTrend = 'up';
        let wheelSpinning = false;
        let lastSpinTime = 0;
        let activeTasks = {};
        let upgrades = {};
        let cryptoOwned = 0;
        let clanData = null;

        // Ses Efektleri
        function playSound(soundId) {
            const sound = document.getElementById(soundId);
            if(sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Ses oynatƒ±lamadƒ±:", e));
            }
        }

        // Toast Bildirim Sistemi
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `glass p-4 rounded-2xl flex items-center gap-3 animate__animated animate__fadeInRight ${type === 'success' ? 'border-l-4 border-emerald-500' : type === 'error' ? 'border-l-4 border-red-500' : 'border-l-4 border-primary'}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle text-emerald-400' : type === 'error' ? 'fa-exclamation-circle text-red-400' : 'fa-info-circle text-primary'}"></i>
                <div class="flex-1">
                    <p class="text-sm font-black">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="material-icons-round text-sm">close</button>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Tema Deƒüi≈ütirme
        window.toggleTheme = () => {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            if(isDark) {
                html.classList.remove('dark');
                html.classList.add('light');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        };

        // Oyun Verileri
        const JOBS = [
            { id: 1, name: "Market Reyon", lv: 1, reward: 500, time: 60, icon: "shopping_cart" },
            { id: 2, name: "≈ûehir Kuryesi", lv: 5, reward: 2000, time: 180, icon: "speed" },
            { id: 3, name: "Yazƒ±lƒ±m Stajƒ±", lv: 10, reward: 8500, time: 600, icon: "code" },
            { id: 4, name: "Borsa Analisti", lv: 15, reward: 25000, time: 1200, icon: "trending_up" },
            { id: 5, name: "CEO Asistanƒ±", lv: 25, reward: 75000, time: 1800, icon: "business_center" }
        ];

        const BIZ = [
            { id: 'kafe', name: "L√ºks Kafe", lv: 10, cost: 100000, income: 8000, icon: "local_cafe" },
            { id: 'galeri', name: "Oto Galeri", lv: 20, cost: 2000000, income: 150000, icon: "directions_car" },
            { id: 'fabrika', name: "Teknoloji Fabrikasƒ±", lv: 30, cost: 10000000, income: 850000, icon: "factory" },
            { id: 'banka', name: "Yatƒ±rƒ±m Bankasƒ±", lv: 50, cost: 50000000, income: 4500000, icon: "account_balance" },
            { id: 'holding', name: "K√ºresel Holding", lv: 100, cost: 250000000, income: 25000000, icon: "corporate_fare" }
        ];

        const TASKS = [
            { id: 'daily_work', name: "3 ƒ∞≈ü Tamamla", type: "daily", reward: 5000, progress: 0, target: 3 },
            { id: 'daily_spin', name: "G√ºnl√ºk √áark √áevir", type: "daily", reward: 2000, progress: 0, target: 1 },
            { id: 'daily_biz', name: "M√ºlk Geliri Topla", type: "daily", reward: 10000, progress: 0, target: 5 },
            { id: 'weekly_money', name: "1.000.000‚Ç∫ Kazan", type: "weekly", reward: 50000, progress: 0, target: 1000000 },
            { id: 'weekly_level', name: "5 Seviye Atla", type: "weekly", reward: 75000, progress: 0, target: 5 }
        ];

        const WHEEL_PRIZES = [
            { text: "1000‚Ç∫", value: 1000, color: "#fbbf24", type: "money" },
            { text: "5000‚Ç∫", value: 5000, color: "#3b82f6", type: "money" },
            { text: "10000‚Ç∫", value: 10000, color: "#10b981", type: "money" },
            { text: "+1 M√ºlk", value: "property", color: "#8b5cf6", type: "property" },
            { text: "x2 Gelir", value: "2x", color: "#ef4444", type: "boost" },
            { text: "500 TCR", value: 500, color: "#06b6d4", type: "crypto" },
            { text: "2500‚Ç∫", value: 2500, color: "#f59e0b", type: "money" },
            { text: "Premium 1g", value: "premium", color: "#ec4899", type: "premium" }
        ];

        // --- AUTH Sƒ∞STEMƒ∞ ---
        window.handleAuth = async (type) => {
            playSound('sound-click');
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if(!e || !p) return showToast("E-posta ve ≈üifre gerekli!", "error");
            try {
                if(type === 'register') {
                    const r = await createUserWithEmailAndPassword(auth, e, p);
                    const username = e.split('@')[0];
                    await set(ref(db, `users/${r.user.uid}`), { 
                        username: username, 
                        money: 10000, 
                        xp: 0, 
                        level: 1, 
                        isOnline: true,
                        totalEarned: 0,
                        tasksCompleted: 0,
                        wheelSpins: 0,
                        playTime: 0,
                        crypto: 0,
                        upgrades: {},
                        lastSpin: 0,
                        dailyTasks: {},
                        clan: null,
                        premiumUntil: 0,
                        rank: 9999,
                        createdAt: serverTimestamp()
                    });
                    showToast("Ho≈ü geldin " + username + "! 10.000‚Ç∫ ba≈ülangƒ±√ß bonusu verildi.", "success");
                } else { 
                    await signInWithEmailAndPassword(auth, e, p);
                    showToast("Tekrar ho≈ü geldin!", "success");
                }
            } catch (err) { 
                showToast("Hata: " + err.message, "error");
            }
        };

        window.logout = () => { 
            update(ref(db, `users/${currentUser.uid}`), { isOnline: false }).then(() => { 
                signOut(auth); 
                location.reload(); 
            }); 
        };

        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                onDisconnect(ref(db, `users/${user.uid}`)).update({ isOnline: false });
                update(ref(db, `users/${user.uid}`), { isOnline: true });
                loadData();
                listenChat();
                listenLeaderboard();
                initWheel();
                startGameLoop();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        // --- VERƒ∞ Y√úKLEME ---
        function loadData() {
            onValue(ref(db, `users/${currentUser.uid}`), (snap) => {
                userData = snap.val(); 
                if(!userData) return;
                
                // UI G√ºncelleme
                document.getElementById('p-username').innerText = userData.username.toUpperCase();
                document.getElementById('p-money').innerHTML = `<i class="fas fa-coins"></i> ${formatMoney(userData.money)}`;
                document.getElementById('p-level').innerText = "LV " + userData.level;
                document.getElementById('p-xp').innerText = (userData.xp % 1000) + "/1000 XP";
                document.getElementById('xp-bar').style.width = (userData.xp % 1000) / 10 + "%";
                document.getElementById('stat-total').innerText = formatMoney(userData.totalEarned || 0);
                document.getElementById('stat-properties').innerText = userData.ownedBiz ? Object.keys(userData.ownedBiz).length : 0;
                document.getElementById('p-rank').innerText = "#" + (userData.rank || 9999);
                
                // Premium kontrol
                if(userData.premiumUntil && userData.premiumUntil > Date.now()) {
                    const days = Math.ceil((userData.premiumUntil - Date.now()) / (1000*60*60*24));
                    document.getElementById('p-premium').innerHTML = `<i class="fas fa-crown text-gold"></i> ${days}g`;
                }
                
                // Seviye bonusu
                const levelBonus = Math.min(userData.level * 2, 100);
                document.getElementById('level-bonus').innerText = `%${levelBonus}`;
                
                // Seviye rozeti
                const levelBadge = document.getElementById('level-badge');
                if(userData.level >= 10) {
                    levelBadge.classList.remove('hidden');
                    levelBadge.innerText = `+%${levelBonus} Gelir`;
                }
                
                // Crypto miktarƒ±
                cryptoOwned = userData.crypto || 0;
                
                // G√ºnl√ºk √ßark kontrol√º
                checkDailyWheel();
                
                // Render i≈ülemleri
                renderJobs();
                renderBiz();
                renderTasks();
                renderClans();
                updateStats();
                
                // ƒ∞≈ü sayacƒ±
                const activeJobs = workInterval ? 1 : 0;
                document.getElementById('stat-active').innerText = activeJobs;
            });
        }

        // --- ƒ∞≈û Sƒ∞STEMƒ∞ ---
        function renderJobs() {
            const grid = document.getElementById('job-grid'); 
            grid.innerHTML = '';
            
            JOBS.forEach(j => {
                const lock = userData.level < j.lv;
                const upgradeBonus = upgrades.speed ? 0.8 : 1; // %20 hƒ±z bonusu
                const actualTime = Math.floor(j.time * upgradeBonus);
                
                grid.innerHTML += `
                <div class="glass p-5 rounded-3xl flex items-center justify-between ${lock ? 'opacity-30' : ''}">
                    <div class="flex items-center gap-4">
                        <span class="material-icons-round text-primary">${j.icon}</span>
                        <div>
                            <p class="font-black text-sm">${j.name}</p>
                            <p class="text-[10px] text-emerald-400 font-bold">‚Ç∫${formatMoney(j.reward)}</p>
                            <p class="text-[8px] text-slate-500">${actualTime}s ‚Ä¢ LV ${j.lv}</p>
                        </div>
                    </div>
                    <button onclick='startWork(${JSON.stringify(j)})' ${lock || workInterval ? 'disabled' : ''} class="bg-primary px-5 py-2 rounded-xl text-xs font-black active:scale-95">
                        ${lock ? 'LV ' + j.lv : 'BA≈ûLA'}
                    </button>
                </div>`;
            });
        }

        window.startWork = (j) => {
            playSound('sound-click');
            if(workInterval) return;
            
            const box = document.getElementById('work-progress-box'); 
            box.classList.remove('hidden');
            
            const upgradeBonus = upgrades.speed ? 0.8 : 1;
            const incomeBonus = upgrades.income ? 1.1 : 1;
            const levelBonus = 1 + (userData.level * 0.02);
            const totalBonus = incomeBonus * levelBonus;
            
            const actualReward = Math.floor(j.reward * totalBonus);
            const actualTime = Math.floor(j.time * upgradeBonus);
            
            let t = 0;
            workInterval = setInterval(() => {
                t++;
                const progress = (t/actualTime)*100;
                document.getElementById('work-bar').style.width = progress + "%";
                document.getElementById('work-time-left').innerText = `Kalan: ${actualTime - t}s`;
                
                if(t >= actualTime) {
                    clearInterval(workInterval); 
                    workInterval = null; 
                    box.classList.add('hidden');
                    
                    // Kazan√ß ve XP
                    const nXp = (userData.xp || 0) + 200;
                    const newLevel = Math.floor(nXp/1000) + 1;
                    const totalEarned = (userData.totalEarned || 0) + actualReward;
                    
                    update(ref(db, `users/${currentUser.uid}`), { 
                        money: userData.money + actualReward, 
                        xp: nXp, 
                        level: newLevel,
                        totalEarned: totalEarned
                    });
                    
                    playSound('sound-coin');
                    showToast(`${j.name} tamamlandƒ±! ${formatMoney(actualReward)}‚Ç∫ kazandƒ±n.`, "success");
                    
                    // Seviye atlama kontrol√º
                    if(newLevel > userData.level) {
                        playSound('sound-levelup');
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                        showToast(`Tebrikler! Seviye ${newLevel}'e ula≈ütƒ±n!`, "success");
                    }
                    
                    // G√∂rev g√ºncelleme
                    updateTaskProgress('daily_work', 1);
                }
            }, 1000);
        };

        // --- M√úLK Sƒ∞STEMƒ∞ ---
        function renderBiz() {
            const grid = document.getElementById('biz-grid'); 
            grid.innerHTML = '';
            
            BIZ.forEach(b => {
                const owned = userData.ownedBiz && userData.ownedBiz[b.id];
                const lock = userData.level < b.lv;
                const last = owned ? owned.lastCollect : 0;
                const ready = Date.now() - last >= 3600000;
                const incomeBonus = upgrades.income ? 1.1 : 1;
                const levelBonus = 1 + (userData.level * 0.02);
                const totalBonus = incomeBonus * levelBonus;
                const actualIncome = Math.floor(b.income * totalBonus);

                grid.innerHTML += `
                <div class="glass p-6 rounded-[32px] ${lock ? 'opacity-20' : ''}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-white/5 rounded-2xl flex items-center justify-center text-emerald-400">
                                <span class="material-icons-round">${b.icon}</span>
                            </div>
                            <div>
                                <p class="font-black text-sm">${b.name}</p>
                                <p class="text-[10px] text-slate-500 font-bold">Gelir: ‚Ç∫${formatMoney(actualIncome)}/saat</p>
                                <p class="text-[8px] text-slate-500">LV ${b.lv} ${owned ? '‚Ä¢ SAHƒ∞P' : ''}</p>
                            </div>
                        </div>
                        ${lock ? `<span class="text-xs font-black text-slate-400">LV ${b.lv}</span>` : ''}
                    </div>
                    ${owned ? 
                        `<button onclick="collectBiz('${b.id}', ${actualIncome})" ${!ready ? 'disabled' : ''} class="w-full py-4 rounded-2xl font-black text-xs ${ready ? 'bg-emerald-500 animate-pulse-glow' : 'bg-white/5 text-slate-500'} active:scale-95">
                            ${ready ? '<i class="fas fa-coins"></i> KAZANCI TOPLA' : 'BEKLENƒ∞YOR...'}
                        </button>` :
                        `<button onclick="buyBiz('${b.id}', ${b.cost})" class="w-full py-4 rounded-2xl bg-primary font-black text-xs active:scale-95">
                            <i class="fas fa-shopping-cart"></i> SATIN AL (‚Ç∫${formatMoney(b.cost)})
                        </button>`
                    }
                </div>`;
            });
        }

        window.buyBiz = (id, cost) => {
            playSound('sound-click');
            if(userData.money >= cost) {
                const bizData = { lastCollect: Date.now() };
                update(ref(db, `users/${currentUser.uid}/ownedBiz/${id}`), bizData);
                update(ref(db, `users/${currentUser.uid}`), { 
                    money: userData.money - cost,
                    totalEarned: (userData.totalEarned || 0) + cost
                });
                showToast("M√ºlk satƒ±n alƒ±ndƒ±!", "success");
                updateTaskProgress('daily_biz', 1);
            } else {
                showToast("Yetersiz bakiye!", "error");
            }
        };

        window.collectBiz = (id, inc) => {
            playSound('sound-coin');
            update(ref(db, `users/${currentUser.uid}/ownedBiz/${id}`), { lastCollect: Date.now() });
            update(ref(db, `users/${currentUser.uid}`), { 
                money: userData.money + inc,
                totalEarned: (userData.totalEarned || 0) + inc
            });
            showToast(`${formatMoney(inc)}‚Ç∫ m√ºlk geliri toplandƒ±!`, "success");
        };

        // --- G√úNL√úK √áARK Sƒ∞STEMƒ∞ ---
        function initWheel() {
            const wheel = document.getElementById('wheel');
            const sliceAngle = 360 / WHEEL_PRIZES.length;
            
            WHEEL_PRIZES.forEach((prize, i) => {
                const slice = document.createElement('div');
                slice.className = 'wheel-section absolute w-full h-full';
                slice.style.transform = `rotate(${i * sliceAngle}deg)`;
                slice.style.clipPath = 'polygon(50% 50%, 50% 0%, 100% 0%)';
                slice.style.backgroundColor = prize.color;
                
                const text = document.createElement('div');
                text.className = 'absolute text-xs font-black text-white';
                text.style.transform = `rotate(${sliceAngle/2}deg) translate(70px) rotate(-${i * sliceAngle + sliceAngle/2}deg)`;
                text.style.textAlign = 'center';
                text.style.width = '60px';
                text.innerText = prize.text;
                
                slice.appendChild(text);
                wheel.appendChild(slice);
            });
        }

        function checkDailyWheel() {
            const now = Date.now();
            const lastSpin = userData.lastSpin || 0;
            const twentyFourHours = 24 * 60 * 60 * 1000;
            const canSpin = (now - lastSpin) >= twentyFourHours;
            
            const spinBtn = document.getElementById('spin-btn');
            const spinText = document.getElementById('spin-text');
            const timer = document.getElementById('wheel-timer');
            
            if(canSpin) {
                spinBtn.disabled = false;
                spinText.innerText = "√áARKI √áEVƒ∞R (G√úNL√úK)";
                timer.classList.add('hidden');
            } else {
                spinBtn.disabled = true;
                const nextSpin = lastSpin + twentyFourHours;
                updateWheelTimer(nextSpin);
                timer.classList.remove('hidden');
            }
        }

        function updateWheelTimer(nextSpinTime) {
            const timer = setInterval(() => {
                const now = Date.now();
                const diff = nextSpinTime - now;
                
                if(diff <= 0) {
                    clearInterval(timer);
                    checkDailyWheel();
                    return;
                }
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('timer').innerText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        window.spinDailyWheel = () => {
            playSound('sound-spin');
            if(wheelSpinning) return;
            
            const wheel = document.getElementById('wheel');
            const spinBtn = document.getElementById('spin-btn');
            
            wheelSpinning = true;
            spinBtn.disabled = true;
            
            // Rastgele √∂d√ºl se√ß
            const prizeIndex = Math.floor(Math.random() * WHEEL_PRIZES.length);
            const prize = WHEEL_PRIZES[prizeIndex];
            
            // D√∂n√º≈ü a√ßƒ±sƒ± hesapla
            const sliceAngle = 360 / WHEEL_PRIZES.length;
            const targetAngle = 360 * 5 + (prizeIndex * sliceAngle) + (Math.random() * sliceAngle - sliceAngle/2);
            
            // Animasyon
            wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.21, 0.99)';
            wheel.style.transform = `rotate(${targetAngle}deg)`;
            
            setTimeout(() => {
                wheelSpinning = false;
                processWheelPrize(prize);
                update(ref(db, `users/${currentUser.uid}`), { 
                    lastSpin: Date.now(),
                    wheelSpins: (userData.wheelSpins || 0) + 1
                });
                checkDailyWheel();
                updateTaskProgress('daily_spin', 1);
            }, 4000);
        };

        function processWheelPrize(prize) {
            playSound('sound-coin');
            
            switch(prize.type) {
                case 'money':
                    update(ref(db, `users/${currentUser.uid}`), { 
                        money: userData.money + prize.value,
                        totalEarned: (userData.totalEarned || 0) + prize.value
                    });
                    showToast(`Tebrikler! √áarktan ${formatMoney(prize.value)}‚Ç∫ kazandƒ±n!`, "success");
                    break;
                    
                case 'property':
                    // Rastgele m√ºlk ver
                    const availableBiz = BIZ.filter(b => !userData.ownedBiz || !userData.ownedBiz[b.id]);
                    if(availableBiz.length > 0) {
                        const randomBiz = availableBiz[Math.floor(Math.random() * availableBiz.length)];
                        update(ref(db, `users/${currentUser.uid}/ownedBiz/${randomBiz.id}`), { lastCollect: Date.now() });
                        showToast(`Tebrikler! √áarktan ${randomBiz.name} m√ºlk√ºn√º kazandƒ±n!`, "success");
                    } else {
                        const moneyPrize = 50000;
                        update(ref(db, `users/${currentUser.uid}`), { money: userData.money + moneyPrize });
                        showToast(`T√ºm m√ºlklere sahipsin! Bunun yerine ${formatMoney(moneyPrize)}‚Ç∫ kazandƒ±n!`, "success");
                    }
                    break;
                    
                case 'boost':
                    // 1 saatlik x2 gelir bonusu
                    showToast(`Tebrikler! 1 saat boyunca x2 gelir bonusu kazandƒ±n!`, "success");
                    // Bonus veritabanƒ±na kaydedilebilir
                    break;
                    
                case 'crypto':
                    update(ref(db, `users/${currentUser.uid}`), { crypto: (userData.crypto || 0) + prize.value });
                    showToast(`Tebrikler! √áarktan ${prize.value} TCR Coin kazandƒ±n!`, "success");
                    break;
                    
                case 'premium':
                    const premiumTime = Date.now() + (24 * 60 * 60 * 1000); // 1 g√ºn
                    update(ref(db, `users/${currentUser.uid}`), { premiumUntil: premiumTime });
                    showToast(`Tebrikler! 1 g√ºnl√ºk Premium √ºyelik kazandƒ±n!`, "success");
                    break;
            }
            
            // Konfeti efekti
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        // --- G√ñREV Sƒ∞STEMƒ∞ ---
        function renderTasks() {
            const container = document.getElementById('tasks-container');
            const dailyList = document.getElementById('daily-tasks-list');
            
            if(!container || !dailyList) return;
            
            container.innerHTML = '';
            dailyList.innerHTML = '';
            
            TASKS.forEach(task => {
                if(task.type === 'daily') {
                    const progress = userData.dailyTasks && userData.dailyTasks[task.id] ? userData.dailyTasks[task.id].progress : 0;
                    const completed = progress >= task.target;
                    
                    dailyList.innerHTML += `
                    <div class="flex items-center justify-between mb-2 last:mb-0">
                        <div class="flex-1">
                            <p class="text-sm font-black">${task.name}</p>
                            <p class="text-xs text-slate-400">${progress}/${task.target}</p>
                        </div>
                        <button onclick="claimTask('${task.id}')" ${!completed ? 'disabled' : ''} class="bg-emerald-500 ${completed ? '' : 'opacity-50'} text-white px-3 py-1 rounded-lg text-xs font-black">
                            ${formatMoney(task.reward)}‚Ç∫
                        </button>
                    </div>`;
                    
                    // Ana ekranda sadece 3 g√∂rev g√∂ster
                    if(container.children.length < 3) {
                        container.innerHTML += `
                        <div class="glass p-4 rounded-2xl flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-emerald-500/20 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-tasks text-emerald-400"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-black">${task.name}</p>
                                    <div class="w-32 bg-black/40 h-2 rounded-full overflow-hidden">
                                        <div class="bg-emerald-500 h-full" style="width: ${(progress/task.target)*100}%"></div>
                                    </div>
                                </div>
                            </div>
                            <button onclick="claimTask('${task.id}')" ${!completed ? 'disabled' : ''} class="bg-emerald-500 ${completed ? '' : 'opacity-50'} text-white px-3 py-1 rounded-lg text-xs font-black">
                                ${formatMoney(task.reward)}‚Ç∫
                            </button>
                        </div>`;
                    }
                }
            });
        }

        function updateTaskProgress(taskId, amount = 1) {
            if(!userData.dailyTasks) userData.dailyTasks = {};
            if(!userData.dailyTasks[taskId]) userData.dailyTasks[taskId] = { progress: 0, claimed: false };
            
            userData.dailyTasks[taskId].progress += amount;
            update(ref(db, `users/${currentUser.uid}/dailyTasks/${taskId}`), userData.dailyTasks[taskId]);
            
            // UI'ƒ± g√ºncelle
            setTimeout(() => renderTasks(), 500);
        }

        window.claimTask = (taskId) => {
            const task = TASKS.find(t => t.id === taskId);
            if(!task) return;
            
            const progress = userData.dailyTasks && userData.dailyTasks[taskId] ? userData.dailyTasks[taskId].progress : 0;
            const claimed = userData.dailyTasks && userData.dailyTasks[taskId] ? userData.dailyTasks[taskId].claimed : false;
            
            if(progress >= task.target && !claimed) {
                playSound('sound-coin');
                
                // √ñd√ºl√º ver
                update(ref(db, `users/${currentUser.uid}`), { 
                    money: userData.money + task.reward,
                    totalEarned: (userData.totalEarned || 0) + task.reward,
                    tasksCompleted: (userData.tasksCompleted || 0) + 1
                });
                
                // G√∂revi tamamlandƒ± olarak i≈üaretle
                update(ref(db, `users/${currentUser.uid}/dailyTasks/${taskId}`), { 
                    progress: progress,
                    claimed: true
                });
                
                showToast(`G√∂rev tamamlandƒ±! ${formatMoney(task.reward)}‚Ç∫ kazandƒ±n.`, "success");
                renderTasks();
            }
        };

        window.claimAllTasks = () => {
            let totalReward = 0;
            let claimedCount = 0;
            
            TASKS.forEach(task => {
                if(task.type === 'daily') {
                    const progress = userData.dailyTasks && userData.dailyTasks[task.id] ? userData.dailyTasks[task.id].progress : 0;
                    const claimed = userData.dailyTasks && userData.dailyTasks[task.id] ? userData.dailyTasks[task.id].claimed : false;
                    
                    if(progress >= task.target && !claimed) {
                        totalReward += task.reward;
                        claimedCount++;
                        
                        // G√∂revi tamamlandƒ± olarak i≈üaretle
                        update(ref(db, `users/${currentUser.uid}/dailyTasks/${task.id}`), { 
                            progress: progress,
                            claimed: true
                        });
                    }
                }
            });
            
            if(claimedCount > 0) {
                playSound('sound-coin');
                update(ref(db, `users/${currentUser.uid}`), { 
                    money: userData.money + totalReward,
                    totalEarned: (userData.totalEarned || 0) + totalReward,
                    tasksCompleted: (userData.tasksCompleted || 0) + claimedCount
                });
                
                showToast(`${claimedCount} g√∂rev tamamlandƒ±! Toplam ${formatMoney(totalReward)}‚Ç∫ kazandƒ±n.`, "success");
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                renderTasks();
            } else {
                showToast("Talep edilecek g√∂rev bulunamadƒ±.", "info");
            }
        };

        // --- KRƒ∞PTO Sƒ∞STEMƒ∞ ---
        function updateCryptoPrice() {
            // Rastgele fiyat deƒüi≈üimi
            const change = (Math.random() - 0.5) * 0.5;
            cryptoPrice = Math.max(5, cryptoPrice + change);
            cryptoPrice = parseFloat(cryptoPrice.toFixed(2));
            
            // Trend belirle
            cryptoTrend = change >= 0 ? 'up' : 'down';
            
            // UI g√ºncelle
            const priceEl = document.getElementById('crypto-price');
            const changeEl = document.getElementById('crypto-change');
            const modalPriceEl = document.getElementById('crypto-modal-price');
            const modalChangeEl = document.getElementById('crypto-modal-change');
            
            if(priceEl) priceEl.innerText = `‚Ç∫${cryptoPrice}`;
            if(changeEl) {
                changeEl.innerText = `${cryptoTrend === 'up' ? '+' : ''}${change.toFixed(2)}%`;
                changeEl.className = `text-[10px] ${cryptoTrend === 'up' ? 'text-emerald-400' : 'text-red-400'}`;
            }
            
            if(modalPriceEl) modalPriceEl.innerText = `‚Ç∫${cryptoPrice}`;
            if(modalChangeEl) {
                modalChangeEl.innerText = `${cryptoTrend === 'up' ? '+' : ''}${change.toFixed(2)}% (24s)`;
                modalChangeEl.className = `text-sm ${cryptoTrend === 'up' ? 'text-emerald-400' : 'text-red-400'}`;
            }
            
            // Sahip olunan crypto deƒüerini g√ºncelle
            updateCryptoValue();
        }

        function updateCryptoValue() {
            const ownedEl = document.getElementById('crypto-owned');
            const valueEl = document.getElementById('crypto-value');
            
            if(ownedEl && cryptoOwned !== undefined) {
                ownedEl.innerText = `${cryptoOwned.toFixed(2)} TCR`;
            }
            
            if(valueEl && cryptoOwned !== undefined) {
                const value = cryptoOwned * cryptoPrice;
                valueEl.innerText = `‚âà ${formatMoney(value)}`;
            }
        }

        window.buyCryptoModal = () => {
            const amount = parseInt(document.getElementById('buy-amount').innerText);
            if(userData.money >= amount) {
                const coins = amount / cryptoPrice;
                cryptoOwned += coins;
                
                update(ref(db, `users/${currentUser.uid}`), { 
                    money: userData.money - amount,
                    crypto: cryptoOwned
                });
                
                showToast(`${coins.toFixed(2)} TCR satƒ±n alƒ±ndƒ±.`, "success");
                updateCryptoValue();
            } else {
                showToast("Yetersiz bakiye!", "error");
            }
        };

        window.sellCryptoModal = () => {
            const amount = parseInt(document.getElementById('sell-amount').innerText);
            if(cryptoOwned >= amount) {
                const value = amount * cryptoPrice;
                cryptoOwned -= amount;
                
                update(ref(db, `users/${currentUser.uid}`), { 
                    money: userData.money + value,
                    crypto: cryptoOwned,
                    totalEarned: (userData.totalEarned || 0) + value
                });
                
                showToast(`${amount} TCR satƒ±ldƒ±. ${formatMoney(value)}‚Ç∫ kazanƒ±ldƒ±.`, "success");
                updateCryptoValue();
            } else {
                showToast("Yeterli TCR yok!", "error");
            }
        };

        // --- MARKET Sƒ∞STEMƒ∞ ---
        window.buyUpgrade = (type) => {
            playSound('sound-click');
            const prices = {
                income: 50000,
                speed: 75000,
                premium: 199000,
                lottery: 5000
            };
            
            const price = prices[type];
            
            if(userData.money >= price) {
                switch(type) {
                    case 'income':
                        upgrades.income = true;
                        showToast("Gelir artƒ±rƒ±cƒ± satƒ±n alƒ±ndƒ±! T√ºm gelirler +%10 arttƒ±.", "success");
                        break;
                    case 'speed':
                        upgrades.speed = true;
                        showToast("Hƒ±z artƒ±rƒ±cƒ± satƒ±n alƒ±ndƒ±! ƒ∞≈ü s√ºreleri -%20 kƒ±saldƒ±.", "success");
                        break;
                    case 'premium':
                        const premiumTime = Date.now() + (30 * 24 * 60 * 60 * 1000); // 30 g√ºn
                        update(ref(db, `users/${currentUser.uid}`), { premiumUntil: premiumTime });
                        showToast("30 g√ºnl√ºk Premium √ºyelik satƒ±n alƒ±ndƒ±!", "success");
                        break;
                    case 'lottery':
                        // Piyango √ßekili≈üi
                        const win = Math.random() < 0.01; // %1 ≈üans
                        if(win) {
                            const jackpot = 10000000;
                            update(ref(db, `users/${currentUser.uid}`), { money: userData.money - price + jackpot });
                            showToast(`TEBRƒ∞KLER! Pƒ∞YANGO JACKPOT'U KAZANDIN: ${formatMoney(jackpot)}‚Ç∫`, "success");
                            confetti({
                                particleCount: 500,
                                spread: 100,
                                origin: { y: 0.6 }
                            });
                        } else {
                            update(ref(db, `users/${currentUser.uid}`), { money: userData.money - price });
                            showToast("Piyango bileti satƒ±n alƒ±ndƒ±. Bir dahaki sefere!", "info");
                        }
                        break;
                }
                
                if(type !== 'lottery' && type !== 'premium') {
                    update(ref(db, `users/${currentUser.uid}/upgrades/${type}`), true);
                }
                
                if(type !== 'lottery') {
                    update(ref(db, `users/${currentUser.uid}`), { money: userData.money - price });
                }
                
                // ƒ∞≈ü ve m√ºlkleri yeniden render et
                renderJobs();
                renderBiz();
            } else {
                showToast("Yetersiz bakiye!", "error");
            }
        };

        // --- KLAN Sƒ∞STEMƒ∞ ---
        function renderClans() {
            const clanList = document.getElementById('clan-list');
            if(!clanList) return;
            
            clanList.innerHTML = `
            <div class="glass p-4 rounded-2xl">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <h4 class="font-black">Elite Traders</h4>
                        <p class="text-xs text-slate-400">Seviye 10+ ‚Ä¢ 245 √ºye</p>
                    </div>
                    <span class="text-xs bg-gold/20 text-gold px-2 py-1 rounded-full">#1</span>
                </div>
                <button onclick="joinClan('elite')" class="w-full bg-primary/20 text-primary py-2 rounded-xl text-xs font-black">
                    KATILMAK ƒ∞√áƒ∞N LV 10
                </button>
            </div>
            <div class="glass p-4 rounded-2xl">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <h4 class="font-black">Crypto Lords</h4>
                        <p class="text-xs text-slate-400">Seviye 5+ ‚Ä¢ 189 √ºye</p>
                    </div>
                    <span class="text-xs bg-slate-500/20 text-slate-400 px-2 py-1 rounded-full">#2</span>
                </div>
                <button onclick="joinClan('crypto')" class="w-full bg-primary/20 text-primary py-2 rounded-xl text-xs font-black">
                    KATILMAK ƒ∞√áƒ∞N LV 5
                </button>
            </div>`;
        }

        window.createClan = () => {
            const name = prompt("Klan adƒ± girin:");
            if(name && name.length >= 3) {
                const cost = 50000;
                if(userData.money >= cost) {
                    const clanId = 'clan_' + Date.now();
                    update(ref(db, `clans/${clanId}`), {
                        name: name,
                        owner: currentUser.uid,
                        level: 1,
                        members: 1,
                        totalWealth: userData.money,
                        created: serverTimestamp()
                    });
                    update(ref(db, `users/${currentUser.uid}`), { 
                        clan: clanId,
                        money: userData.money - cost
                    });
                    showToast(`${name} klanƒ± kuruldu!`, "success");
                } else {
                    showToast("Klan kurmak i√ßin 50.000‚Ç∫ gerekiyor!", "error");
                }
            }
        };

        // --- SOSYAL & Lƒ∞DERLƒ∞K ---
        function listenLeaderboard() {
            const lbQ = query(ref(db, 'users'), orderByChild('money'), limitToLast(10));
            onValue(lbQ, (snap) => {
                const list = document.getElementById('leaderboard'); 
                if(!list) return;
                
                list.innerHTML = '';
                const users = []; 
                snap.forEach(s => { 
                    users.push({uid: s.key, ...s.val()}); 
                });
                
                users.sort((a, b) => b.money - a.money);
                
                users.forEach((u, i) => {
                    list.innerHTML += `
                    <div onclick="viewProfile('${u.uid}')" class="flex items-center gap-3 cursor-pointer active:scale-95 transition">
                        <span class="text-[10px] font-black w-4 ${i < 3 ? 'text-gold' : 'text-slate-600'}">${i+1}</span>
                        <div class="w-10 h-10 ${i < 3 ? 'bg-gold/20' : 'bg-white/5'} rounded-xl flex items-center justify-center font-black">
                            ${u.username[0].toUpperCase()}
                        </div>
                        <div class="flex-1 truncate">
                            <div class="font-bold text-sm">${u.username}</div>
                            <div class="text-[10px] text-slate-400">LV ${u.level || 1}</div>
                        </div>
                        <div class="text-emerald-400 font-black text-xs">${formatMoney(u.money)}</div>
                    </div>`;
                });
                
                // Kullanƒ±cƒ±nƒ±n sƒ±ralamasƒ±nƒ± g√ºncelle
                if(currentUser) {
                    const userIndex = users.findIndex(u => u.uid === currentUser.uid);
                    if(userIndex !== -1) {
                        update(ref(db, `users/${currentUser.uid}`), { rank: userIndex + 1 });
                    }
                }
            });
        }

        window.viewProfile = async (uid) => {
            playSound('sound-click');
            const snap = await get(ref(db, `users/${uid}`));
            const d = snap.val(); 
            if(!d) return;
            
            viewedUid = uid;
            document.getElementById('prof-username').innerText = d.username.toUpperCase();
            document.getElementById('prof-money').innerText = formatMoney(d.money);
            document.getElementById('prof-level').innerText = "LV " + d.level;
            document.getElementById('prof-avatar').innerText = d.username[0].toUpperCase();
            document.getElementById('prof-rank').innerText = "#" + (d.rank || 9999);
            document.getElementById('prof-total').innerText = formatMoney(d.totalEarned || 0);
            document.getElementById('prof-tasks').innerText = d.tasksCompleted || 0;
            document.getElementById('prof-spins').innerText = d.wheelSpins || 0;
            document.getElementById('prof-playtime').innerText = formatTime(d.playTime || 0);
            
            if(d.premiumUntil && d.premiumUntil > Date.now()) {
                const days = Math.ceil((d.premiumUntil - Date.now()) / (1000*60*60*24));
                document.getElementById('prof-premium').innerHTML = `<i class="fas fa-crown text-gold"></i> ${days}g`;
            } else {
                document.getElementById('prof-premium').innerHTML = '';
            }
            
            const assets = document.getElementById('prof-assets'); 
            assets.innerHTML = '';
            if(d.ownedBiz && Object.keys(d.ownedBiz).length > 0) {
                Object.keys(d.ownedBiz).forEach(k => {
                    const b = BIZ.find(x => x.id === k);
                    if(b) assets.innerHTML += `<span class="bg-primary/10 text-primary px-3 py-1 rounded-full text-[10px] font-black">${b.name}</span>`;
                });
            } else {
                assets.innerHTML = '<p class="text-xs text-slate-500 italic">Hi√ß m√ºlk√º yok.</p>';
            }
            
            document.getElementById('profile-modal').classList.remove('hidden');
        };

        window.sendMoney = () => {
            const m = prompt("G√∂ndermek istediƒüin miktar (‚Ç∫):");
            if(m && !isNaN(m) && parseInt(m) > 0) {
                if(userData.money >= parseInt(m)) {
                    get(ref(db, `users/${viewedUid}`)).then(s => {
                        const targetData = s.val();
                        update(ref(db, `users/${viewedUid}`), { money: (targetData.money || 0) + parseInt(m) });
                        update(ref(db, `users/${currentUser.uid}`), { money: userData.money - parseInt(m) });
                        showToast(`${formatMoney(parseInt(m))}‚Ç∫ ba≈üarƒ±yla g√∂nderildi!`, "success");
                        closeProfile();
                    });
                } else {
                    showToast("Yetersiz bakiye!", "error");
                }
            }
        };

        window.buyPremium = () => {
            const cost = 199000;
            if(userData.money >= cost) {
                const premiumTime = Date.now() + (30 * 24 * 60 * 60 * 1000);
                update(ref(db, `users/${currentUser.uid}`), { 
                    money: userData.money - cost,
                    premiumUntil: premiumTime
                });
                showToast("30 g√ºnl√ºk Premium √ºyelik satƒ±n alƒ±ndƒ±!", "success");
                closeProfile();
            } else {
                showToast("Premium √ºyelik i√ßin 199.000‚Ç∫ gerekiyor!", "error");
            }
        };

        // --- CHAT Sƒ∞STEMƒ∞ ---
        window.sendMessage = () => {
            const i = document.getElementById('chat-input');
            if(!i.value.trim()) return;
            
            playSound('sound-click');
            push(ref(db, 'chat'), { 
                uid: currentUser.uid, 
                name: userData.username, 
                msg: i.value, 
                time: serverTimestamp(),
                level: userData.level,
                premium: userData.premiumUntil > Date.now()
            });
            i.value = '';
        };

        function listenChat() {
            onValue(ref(db, 'chat'), (snap) => {
                const box = document.getElementById('chat-messages'); 
                if(!box) return;
                
                box.innerHTML = '';
                const messages = [];
                snap.forEach(s => {
                    messages.push({ id: s.key, ...s.val() });
                });
                
                // Son 50 mesajƒ± g√∂ster
                messages.slice(-50).forEach(m => {
                    const isMe = m.uid === currentUser.uid;
                    const time = m.time ? new Date(m.time).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) : '≈üimdi';
                    
                    box.innerHTML += `
                    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                        <span class="text-[9px] text-slate-500 mb-1 px-2 flex items-center gap-2" onclick="viewProfile('${m.uid}')">
                            ${m.name} 
                            <span class="text-[8px] bg-primary/20 text-primary px-1 rounded">LV ${m.level || 1}</span>
                            ${m.premium ? '<i class="fas fa-crown text-gold text-[8px]"></i>' : ''}
                        </span>
                        <div class="${isMe ? 'bg-primary rounded-tr-none' : 'bg-white/5 rounded-tl-none'} p-3 rounded-2xl text-sm max-w-[85%]">
                            ${m.msg}
                            <div class="text-[9px] text-slate-500 mt-1 text-right">${time}</div>
                        </div>
                    </div>`;
                });
                
                box.scrollTop = box.scrollHeight;
            });
            
            // √áevrimi√ßi sayƒ±sƒ±
            onValue(ref(db, 'users'), (snap) => {
                let onlineCount = 0;
                snap.forEach(() => onlineCount++);
                const onlineEl = document.getElementById('online-count');
                if(onlineEl) onlineEl.innerText = `(${onlineCount})`;
            });
        }

        // --- UI YARDIMCILARI ---
        function formatMoney(amount) {
            if(amount >= 1000000) {
                return (amount/1000000).toFixed(2) + 'M';
            } else if(amount >= 1000) {
                return (amount/1000).toFixed(1) + 'K';
            }
            return amount.toLocaleString('tr-TR');
        }

        function formatTime(seconds) {
            if(seconds >= 3600) {
                return Math.floor(seconds/3600) + 's ' + Math.floor((seconds%3600)/60) + 'd';
            } else if(seconds >= 60) {
                return Math.floor(seconds/60) + 'd ' + (seconds%60) + 's';
            }
            return seconds + 's';
        }

        function updateStats() {
            // Oyun s√ºresini g√ºncelle
            if(userData.createdAt) {
                const created = new Date(userData.createdAt).getTime();
                const playTime = Math.floor((Date.now() - created) / 1000);
                update(ref(db, `users/${currentUser.uid}`), { playTime: playTime });
            }
        }

        // Oyun d√∂ng√ºs√º
        function startGameLoop() {
            // Crypto fiyat g√ºncelleme
            setInterval(updateCryptoPrice, 5000);
            
            // Oyun istatistiklerini g√ºncelleme
            setInterval(updateStats, 30000);
            
            // M√ºlk gelirlerini kontrol etme
            setInterval(() => {
                if(userData.ownedBiz) {
                    Object.keys(userData.ownedBiz).forEach(id => {
                        const last = userData.ownedBiz[id].lastCollect;
                        if(Date.now() - last >= 3600000) {
                            // Gelir hazƒ±r
                            const biz = BIZ.find(b => b.id === id);
                            if(biz) {
                                const incomeBonus = upgrades.income ? 1.1 : 1;
                                const levelBonus = 1 + (userData.level * 0.02);
                                const totalBonus = incomeBonus * levelBonus;
                                const actualIncome = Math.floor(biz.income * totalBonus);
                                
                                // Bildirim g√∂ster
                                showToast(`${biz.name} geliri hazƒ±r: ${formatMoney(actualIncome)}‚Ç∫`, "info");
                            }
                        }
                    });
                }
            }, 60000);
        }

        // Modal fonksiyonlarƒ±
        window.toggleChat = () => {
            playSound('sound-click');
            document.getElementById('chat-modal').classList.toggle('hidden');
        };

        window.toggleProfile = () => {
            playSound('sound-click');
            if(currentUser) {
                viewProfile(currentUser.uid);
            }
        };

        window.closeProfile = () => {
            document.getElementById('profile-modal').classList.add('hidden');
        };

        window.openWheel = () => {
            playSound('sound-click');
            document.getElementById('wheel-modal').classList.remove('hidden');
            checkDailyWheel();
        };

        window.closeWheel = () => {
            document.getElementById('wheel-modal').classList.add('hidden');
        };

        window.openCrypto = () => {
            playSound('sound-click');
            document.getElementById('crypto-modal').classList.remove('hidden');
            updateCryptoValue();
        };

        window.closeCrypto = () => {
            document.getElementById('crypto-modal').classList.add('hidden');
        };

        window.openTasks = () => {
            playSound('sound-click');
            document.getElementById('tasks-modal').classList.remove('hidden');
        };

        window.closeTasks = () => {
            document.getElementById('tasks-modal').classList.add('hidden');
        };

        window.openMarket = () => {
            playSound('sound-click');
            document.getElementById('market-modal').classList.remove('hidden');
        };

        window.closeMarket = () => {
            document.getElementById('market-modal').classList.add('hidden');
        };

        window.openClans = () => {
            playSound('sound-click');
            document.getElementById('clan-modal').classList.remove('hidden');
        };

        window.closeClans = () => {
            document.getElementById('clan-modal').classList.add('hidden');
        };

        // Diƒüer UI fonksiyonlarƒ±
        window.toggleNotifications = () => {
            playSound('sound-click');
            showToast("Bildirimler aktif!", "info");
        };

        window.updateBuyAmount = () => {
            const slider = document.getElementById('buy-slider');
            const amount = document.getElementById('buy-amount');
            if(slider && amount) {
                amount.innerText = parseInt(slider.value).toLocaleString();
            }
        };

        window.updateSellAmount = () => {
            const slider = document.getElementById('sell-slider');
            const amount = document.getElementById('sell-amount');
            if(slider && amount) {
                amount.innerText = parseInt(slider.value).toLocaleString();
            }
        };

        // ƒ∞lk deƒüerleri ayarla
        if(document.getElementById('buy-slider')) {
            document.getElementById('buy-slider').addEventListener('input', updateBuyAmount);
            document.getElementById('sell-slider').addEventListener('input', updateSellAmount);
        }

        // Sayfa y√ºklendiƒüinde tema kontrol√º
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.className = savedTheme;
            
            // Auth butonlarƒ±na ses efekti ekle
            document.getElementById('btn-login')?.addEventListener('click', () => playSound('sound-click'));
            document.getElementById('btn-register')?.addEventListener('click', () => playSound('sound-click'));
        });

    </script>
</body>
</html>
